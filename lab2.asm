	.ORIG	X3000			;establish program start
	AND	R0, R0, x0		;reinitialize counter and range registers
					
OUTER	LD	R2, ADDRESS		;begin OUTER loop
	AND	R1, R1, x0
	AND	R0, R0, x0
	
INNER	LDR	R3, R2, x0		;begin INNER loop
	LD	R6, MASK1
	AND	R7, R3, R6
	BRZ	NXTPASS
	
	LD	R6, MASK2
	AND	R3, R3, R6
	LD	R7, EIGHT
SHIFT	ADD	R3, R3, x0		;Shift used to put score in [7:0]
	BRP	PLUS
	BRN	STAY
STAY	ADD	R3, R3, R3
	ADD	R3, R3, #1
	BR	N0
PLUS	ADD	R3, R3, R3
N0	ADD	R7, R7, #-1
	BRP	SHIFT

	LDR	R4, R2, #1
	LD	R6, MASK1
	AND	R7, R4, R6
	BRZ	BOTTOM

	LD	R6, MASK2
	AND	R4, R4, R6
	LD	R7, EIGHT
SHIFT2	ADD	R4, R4, x0
		BRP	PLUS2
		BRN	STAY2
	STAY2	ADD	R4, R4, R4
		ADD	R4, R4, #1
		BR	N1
	PLUS2	ADD	R4, R4, R4
	N1	ADD	R7, R7, x-1
		BRP	SHIFT2

	NOT	R5, R4
	ADD	R5, R5, x1
	ADD	R5, R3, R5
	BRZP	BOTTOM
	LDR	R3, R2, x0
	LDR	R4, R2, x1
	STR	R4, R2, x0
	STR	R3, R2, x1
	ADD	R1, R1, x1
	BR	BOTTOM

BOTTOM	ADD	R0, R0, x1
	ADD	R2, R2, x1
	BR	INNER

NXTPASS	ADD	R1, R1, x0
	BRP	OUTER
	
	STI 	R0, STUDENTS
	ADD	R0, R0, x0
	BRP	FRANGE
	AND	R0, R0, x-1
	STI	R0, RANGE
	STI	R0, MEDIAN
	BR	END

FRANGE	LDI	R5, ADDRESS
	LD	R6, MASK2
	AND	R5, R5, R6
	LDR	R6, R2, x-1

	LD	R4, MASK2
	AND	R6, R6, R4
	LD	R7, EIGHT	
SHIFT3	ADD	R6, R6, x0
		BRP	PLUS3
		BRN	STAY3
	STAY3	ADD	R6, R6, R6
		ADD	R6, R6, #1
		BR	N3
	PLUS3	ADD	R6, R6, R6
	N3	ADD	R7, R7, x-1
		BRP	SHIFT3	
	ADD	R7, R6, R5
	STI	R7, RANGE

	AND	R1, R1, x0

FMEDIAN	ADD	R1, R1, x1
	ADD	R0, R0, x-2
	BRP	FMEDIAN
	BRN	MNEG			;odd number
	BRZ	MZERO			;even number

MNEG	LD	R2, ADDRESS
	ADD	R2, R2, R1
	LDR	R3, R2, x0
	
	LD	R1, MASK2
	AND	R3, R3, R1
	LD	R7, EIGHT
SHIFT4	ADD	R3, R3, x0
		BRP	PLUS4
		BRN	STAY4
	STAY4	ADD	R3, R3, R3
		ADD	R3, R3, #1
		BR	N4
	PLUS4	ADD	R3, R3, R3
	N4	ADD	R7, R7, x-1
		BRP	SHIFT4

	STI	R3, MEDIAN
	BR	END

MZERO	LD	R2, MEDIAN
	LD	R3, ADDRESS
	ADD	R2, R2, R1
	ADD	R3, R3, R1
	LDR	R4, R2, x0

	LD	R0, MASK2
	AND	R4, R4, R0
	LD	R7, EIGHT
SHIFT5	ADD	R4, R4, x0
		BRP	PLUS5
		BRN	STAY5
	STAY5	ADD	R4, R4, R4
		ADD	R4, R4, #1
		BR	N5
	PLUS5	ADD	R4, R4, R4
	N5	ADD	R7, R7, x-1
		BRP	SHIFT5

	LDR	R5, R3, x0

	AND	R5, R5, R0
	LD	R7, EIGHT
SHIFT6	ADD	R5, R5, x0
		BRP	PLUS6
		BRN	STAY6
	STAY6	ADD	R5, R5, R5
		ADD	R5, R5, #1
		BR	N6
	PLUS6	ADD	R5, R5, R5
	N6	ADD	R7, R7, x-1
		BRP	SHIFT6
	
	ADD	R6, R5, R4
	LD	R1, MASK3
	AND	R6, R6, R1

	LD	R7, FIFTEEN
SHIFT7	ADD	R6, R6, x0
		BRP	PLUS7
		BRN	STAY7
	STAY7	ADD	R6, R6, R6
		ADD	R6, R6, #1
		BR	N7
	PLUS7	ADD	R6, R6, R6
	N7	ADD	R7, R7, x-1
		BRP	SHIFT7	
	
	STI	R6, MEDIAN
END	HALT
	

ADDRESS	 .FILL	x4003
RANGE	 .FILL	x4000
STUDENTS .FILL	x4001
MEDIAN	 .FILL	x4002
MASK1	 .FILL	X00FF
MASK2	 .FILL	XFF00
EIGHT	 .FILL	x0008
FIFTEEN	 .FILL	#15
MASK3	 .FILL	xFFFE
	 .END
	